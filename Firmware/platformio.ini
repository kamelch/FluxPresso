[platformio]
; Firmware is built with: `pio run -e waveshare-s3-35b`
; Unit tests: `pio test -e native`

[env:waveshare-s3-35b]
platform = espressif32@6.4.0
board = esp32-s3-devkitc-1
framework = arduino

; Unit tests are executed on the host (native) only.
test_ignore = *

board_build.partitions = partitions_16MB.csv
board_build.flash_mode = qio
board_build.f_cpu = 240000000L
board_build.f_flash = 80000000L

; Waveshare ESP32-S3-Touch-LCD-3.5B: 16MB flash + 8MB OPI PSRAM (ESP32-S3R8)
board_upload.flash_size = 16MB
board_build.arduino.memory_type = qio_opi

monitor_speed = 115200
monitor_filters = esp32_exception_decoder

build_flags = 
    -DCORE_DEBUG_LEVEL=3
    -DBOARD_HAS_PSRAM
    -mfix-esp32-psram-cache-issue
    -DLV_CONF_INCLUDE_SIMPLE
    -DLV_LVGL_H_INCLUDE_SIMPLE
    -I src
    -DENABLE_SOAK_TEST=0
    ; Board identifier for conditional compilation if needed
    -DBOARD_WAVESHARE_S3_35B=1

lib_deps = 
    lvgl/lvgl@^8.3.11
    adafruit/Adafruit MAX31855 library@^1.4.0
    bogde/HX711@^0.7.5
    bblanchon/ArduinoJson@^6.21.3
    moononournation/GFX Library for Arduino@1.4.7
    ArduinoOTA@2.0.0
    ; TCA9554 and AXP2101 are handled via raw I2C in hal.cpp — no external libraries needed
    ; Touch is handled via raw I2C to AXS15231B (0x3B) — no external touch library needed

upload_speed = 921600

; -------------------- Unit test environment --------------------
[env:native]
platform = native
test_framework = unity

build_unflags =
    -std=c++15
    -std=gnu++17
    -std=c++17
    -std=gnu++14
    -std=c++14
    -std=gnu++11
    -std=c++11

build_flags =
    -DUNIT_TEST
    -std=c++11

build_src_filter =
    -<*>
    +<logic/*>
    +<controllers/*>
    +<utils/*>


; -------------------- OTA upload (WiFi) --------------------
; 1) Flash once via USB using env:waveshare-s3-35b
; 2) Then use this env to upload over WiFi (ArduinoOTA / espota)
[env:ota]
extends = env:waveshare-s3-35b
upload_protocol = espota
; Set this to your ESP32 IP (printed in Serial as "WiFi: connected (...)") or use mDNS hostname.
upload_port = 192.168.1.123
upload_flags =
    --port=3232
; Optional auth (must match OTA_PASSWORD in project_config.h)
;    --auth=yourpassword
